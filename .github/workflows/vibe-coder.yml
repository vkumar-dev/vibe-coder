name: Vibe Coder - Scheduled App Generation

on:
  schedule:
    # Run every 4 hours: 00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC
    - cron: '0 */4 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      max_ideas:
        description: 'Maximum ideas to process'
        required: false
        default: '5'

jobs:
  vibe-coder:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup GitHub CLI
      run: |
        gh --version || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
        sudo apt update && sudo apt install gh -y)
    
    - name: Configure Git
      run: |
        git config --global user.name "vibe-coder-bot"
        git config --global user.email "vibe-coder@users.noreply.github.com"
    
    - name: Run Vibe Coder
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        source venv/bin/activate
        MAX_IDEAS="${{ github.event.inputs.max_ideas || 5 }}"
        echo "Running vibe coder with max_ideas=$MAX_IDEAS"
        python vibe_coder.py run --max-ideas $MAX_IDEAS
    
    - name: Commit and push generated apps
      run: |
        git add projects/
        git diff --staged --quiet || git commit -m "ðŸŽ¨ Vibe Coder: Generated new app [skip ci]"
        git push
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vibe-coder-output
        path: |
          projects/
          logs/
          state/
        retention-days: 30
